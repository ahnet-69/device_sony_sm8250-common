From b68b1ac48d33e349d156481b8fac3c3fc4bf9fdd Mon Sep 17 00:00:00 2001
From: Vishalcj17 <vishalcj@aospa.co>
Date: Sun, 19 Nov 2023 02:13:13 +0900
Subject: [PATCH] Settings: Add a toggle for High touch polling rate

Co-authored-by: Danny Lin <danny@kdrag0n.dev>
Change-Id: I86af721fde33226d314d8a44525f310828299a72
---
 res/values/config.xml                         |  2 +
 res/values/strings.xml                        |  5 ++
 res/xml/display_settings.xml                  |  6 ++
 .../TouchPollingPreferenceController.java     | 61 +++++++++++++++++++
 4 files changed, 74 insertions(+)
 create mode 100644 src/com/android/settings/display/TouchPollingPreferenceController.java

diff --git a/res/values/config.xml b/res/values/config.xml
index 42d168d..80adc83 100644
--- a/res/values/config.xml
+++ b/res/values/config.xml
@@ -783,4 +783,6 @@
     <!-- Whether to display pSIM conversion menu in Settings.-->
     <bool name="config_psim_conversion_menu_enabled">false</bool>
 
+    <!-- Whether device supports increased touch sensitvity -->
+    <bool name="config_supportTouchPollingMode">false</bool>
 </resources>
diff --git a/res/values/strings.xml b/res/values/strings.xml
index 292a5cc..5a44c0d 100644
--- a/res/values/strings.xml
+++ b/res/values/strings.xml
@@ -12633,4 +12633,9 @@
     <string name="content_protection_preference_subpage_summary"></string>
     <!-- Default information at the bottom of the subpage of content protection settings. Will be overlaid by OEM. -->
     <string name="content_protection_preference_subpage_info"></string>
+
+    <!-- Display settings screen, increased touch polling rate settings title -->
+    <string name="touch_polling_title">High touch polling rate</string>
+    <!-- Display settings screen, increased touch polling rate settings summary -->
+    <string name="touch_polling_summary">Increase touchscreen polling rate to decrease latency</string>
 </resources>
diff --git a/res/xml/display_settings.xml b/res/xml/display_settings.xml
index fd4478f..73b8adc 100644
--- a/res/xml/display_settings.xml
+++ b/res/xml/display_settings.xml
@@ -248,6 +248,12 @@
             android:defaultValue="false"
             settings:requiresFeature="lineagehardware:FEATURE_HIGH_TOUCH_POLLING_RATE" />
 
+        <SwitchPreferenceCompat
+            android:key="touch_polling"
+            android:title="@string/touch_polling_title"
+            android:summary="@string/touch_polling_summary"
+            settings:controller="com.android.settings.display.TouchPollingPreferenceController" />
+
         <SwitchPreferenceCompat
             android:key="touch_sensitivity"
             android:title="@string/touch_sensitivity_title"
diff --git a/src/com/android/settings/display/TouchPollingPreferenceController.java b/src/com/android/settings/display/TouchPollingPreferenceController.java
new file mode 100644
index 0000000..fdb9634
--- /dev/null
+++ b/src/com/android/settings/display/TouchPollingPreferenceController.java
@@ -0,0 +1,61 @@
+/*
+ * Copyright (C) 2021 The Proton AOSP Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.settings.display;
+
+import android.content.Context;
+import android.os.SystemProperties;
+import android.provider.Settings;
+
+import com.android.settings.core.TogglePreferenceController;
+import com.android.settings.R;
+
+public class TouchPollingPreferenceController extends TogglePreferenceController {
+
+    // Settings can only set the debug.* property, so we need to persist it
+    // in system settings. Match the stock setting name for backup compatibility.
+    private static final String SETTINGS_KEY = "touch_polling_enabled";
+    private static final String PROP_NAME = "debug.touch_polling_mode";
+
+    public TouchPollingPreferenceController(Context context, String preferenceKey) {
+        super(context, preferenceKey);
+    }
+
+    @Override
+    public int getAvailabilityStatus() {
+        return mContext.getResources().getBoolean(R.bool.config_supportTouchPollingMode)
+            ? AVAILABLE
+            : UNSUPPORTED_ON_DEVICE;
+    }
+
+    @Override
+    public boolean setChecked(boolean value) {
+        Settings.Secure.putInt(mContext.getContentResolver(), SETTINGS_KEY, value ? 1 : 0);
+        SystemProperties.set(PROP_NAME, value ? "1" : "0");
+        return true;
+    }
+
+    @Override
+    public boolean isChecked() {
+        // debug prop isn't persistent
+        return Settings.Secure.getInt(mContext.getContentResolver(), SETTINGS_KEY, 0) == 1;
+    }
+
+    @Override
+    public int getSliceHighlightMenuRes() {
+        return R.string.menu_key_display;
+    }
+}
-- 
2.43.0

